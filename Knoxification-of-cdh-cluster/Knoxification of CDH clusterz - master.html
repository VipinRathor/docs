<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 7.5.2 (457164)"/><meta name="altitude" content="25.3145866394043"/><meta name="author" content="thekat"/><meta name="created" content="2019-02-19 02:52:10 +0000"/><meta name="latitude" content="37.32834187811671"/><meta name="longitude" content="-121.8865863397385"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2019-02-19 03:35:50 +0000"/><title>Knoxification of CDH clusterz - master</title></head><body><div><span style="font-weight: bold; font-size: 24px;">Knoxification of CDH 6.1 clusterz</span></div><div><br/></div><div><span style="font-weight: bold;">Goal: </span></div><div>Integrate CDH 6.1 Services with Knox</div><div><br/></div><div><span style="font-weight: bold;">Prerequisites:</span></div><ul><li><div>A CDH 6.1 cluster</div></li><li><div>Kerberos enabled against FreeIPA</div></li><li><div>Install Knox on a CDH "Edge Node" so it has the proper client configs</div></li></ul><div><br/></div><div><br/></div><div><span style="font-weight: bold;">Knox - CDH 6.1 Service Matrix:</span></div><div><div><br/></div><table style="border-collapse: collapse; min-width: 100%;"><colgroup><col style="width: 148px;"/><col style="width: 428px;"/><col style="width: 891px;"/></colgroup><tbody><tr><td style="border: 1px solid rgb(219, 219, 219); width: 148px; padding: 8px;"><div><span style="font-weight: bold;">Service Endpoint</span></div></td><td style="border: 1px solid rgb(219, 219, 219); width: 428px; padding: 8px;"><div><span style="font-weight: bold;">Knox Proxy URL</span></div></td><td style="border: 1px solid rgb(219, 219, 219); width: 891px; padding: 8px;"><div><span style="font-weight: bold;">Knox SSO URL</span></div></td></tr><tr><td style="border: 1px solid rgb(219, 219, 219); width: 148px; padding: 8px;"><div>HDFS NameNode UI</div></td><td style="border: 1px solid rgb(219, 219, 219); width: 428px; padding: 8px;"><div>??</div></td><td style="border: 1px solid rgb(219, 219, 219); width: 891px; padding: 8px;"><div><a href="http://cdh-1.evilcorp.pro:9870/index.html">http://cdh-1.evilcorp.pro:9870/index.html</a></div></td></tr><tr><td style="border: 1px solid rgb(219, 219, 219); width: 148px; padding: 8px;"><div>WebHDFS REST API</div></td><td style="border: 1px solid rgb(219, 219, 219); width: 428px; padding: 8px;"><div><a href="https://cdh-3.evilcorp.pro:8443/gateway/fortknox/webhdfs/v1/?op=LISTSTATUS">https://cdh-3.evilcorp.pro:8443/gateway/fortknox/webhdfs/v1/?op=LISTSTATUS</a>  </div></td><td style="border: 1px solid rgb(219, 219, 219); width: 891px; padding: 8px;"><div>??</div></td></tr><tr><td style="border: 1px solid rgb(219, 219, 219); width: 148px; padding: 8px;"><div>YARN Resource Manager UI</div></td><td style="border: 1px solid rgb(219, 219, 219); width: 428px; padding: 8px;"><div><a href="https://cdh-3.evilcorp.pro:8443/gateway/fortknox/yarn/">https://cdh-3.evilcorp.pro:8443/gateway/fortknox/yarn/</a></div></td><td style="border: 1px solid rgb(219, 219, 219); width: 891px; padding: 8px;"><div><a href="http://cdh-1.evilcorp.pro:8088/">http://cdh-1.evilcorp.pro:8088</a></div></td></tr><tr><td style="border: 1px solid rgb(219, 219, 219); width: 148px; padding: 8px;"><div>Job History Server</div></td><td style="border: 1px solid rgb(219, 219, 219); width: 428px; padding: 8px;"><div>N/A</div></td><td style="border: 1px solid rgb(219, 219, 219); width: 891px; padding: 8px;"><div><a href="http://cdh1-evilcorp.pro:19888/jobhistory">http://cdh-1.evilcorp.pro:19888/jobhistory</a></div></td></tr><tr><td style="border: 1px solid rgb(219, 219, 219); width: 148px; padding: 8px;"><div>Spark History Server</div></td><td style="border: 1px solid rgb(219, 219, 219); width: 428px; padding: 8px;"><div><a href="https://cdh-3.evilcorp.pro:8443/gateway/fortknox/sparkhistory">https://cdh-3.evilcorp.pro:8443/gateway/fortknox/sparkhistory</a></div></td><td style="border: 1px solid rgb(219, 219, 219); width: 891px; padding: 8px;"><div><a href="http://cdh-1.evilcorp.pro:18088/">http://cdh-1.evilcorp.pro:18088/</a></div></td></tr></tbody></table><div><br/></div></div><hr/><div><span style="font-weight: bold;"># 1. Download knox server 1.2 binary</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>mkdir /opt/knox</div><div>cd /opt/knox</div><div>sudo chown noobie /opt/knox</div><div>curl -o knox-1.2.0.zip <a href="http://apache.cs.utah.edu/knox/1.2.0/knox-1.2.0.zip">http://apache.cs.utah.edu/knox/1.2.0/knox-1.2.0.zip</a></div><div><br/></div><div>sudo yum install unzip</div></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>unzip knox-1.2.0.zip</div></div><div><br/></div><div><span style="font-size: 14px; font-family: &quot;Helvetica Neue&quot;; font-weight: bold;"># 2. Update knox configurations</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div># Inside the  /opt/knox/knox-1.2.0/conf/</div><div><br/></div><div># 2.1 create krb5JAASLogin.conf</div><div>com.sun.security.jgss.initiate {</div><div>    com.sun.security.auth.module.Krb5LoginModule required</div><div>    renewTGT=false</div><div>    doNotPrompt=true</div><div>    useKeyTab=true</div><div>    keyTab="/etc/security/knox.keytab"</div><div>    principal="knox/<a href="mailto:cdh-3.evilcorp.pro@EVILCORP.PRO">cdh-3.evilcorp.pro@EVILCORP.PRO</a>"</div><div>    isInitiator=true</div><div>    storeKey=true</div><div>    useTicketCache=false</div><div>    client=true;</div><div>};</div><div><br/></div><div># 2.2    /opt/knox/knox-1.2.0/conf/gateway-site.xml</div><div><br/></div><div># Modify gateway-site.xml. Match /pathtoknox/conf/krb5JAASLogin.conf to the location you untarred knox :</div><div><br/></div><div>   &lt;property&gt;</div><div>        &lt;name&gt;gateway.hadoop.kerberos.secured&lt;/name&gt;</div><div>        &lt;value&gt;true&lt;/value&gt;</div><div>        &lt;description&gt;Boolean flag indicating whether the Hadoop cluster protected by Gateway is secured with Kerberos&lt;/description&gt;</div><div>    &lt;/property&gt;</div><div>    &lt;property&gt;</div><div>        &lt;name&gt;java.security.krb5.conf&lt;/name&gt;</div><div>        &lt;value&gt;/etc/krb5.conf&lt;/value&gt;</div><div>        &lt;description&gt;Absolute path to krb5.conf file&lt;/description&gt;</div><div>    &lt;/property&gt;</div><div>    &lt;property&gt;</div><div>        &lt;name&gt;java.security.auth.login.config&lt;/name&gt;</div><div>        &lt;value&gt;/opt/knox/knox-1.2.0/conf/krb5JAASLogin.conf&lt;/value&gt;</div><div>        &lt;description&gt;Absolute path to JAAS login config file&lt;/description&gt;</div><div>    &lt;/property&gt;</div></div><div><br/></div><div><span style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"># Create knox master secret</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>cd /opt/knox/knox-1.2.0/bin/</div><div>bin/knoxcli.sh create-master</div><div><br/></div><div>Enter master secret: useabetterpassw0rd</div><div><br/></div></div><div><br/></div><div><span style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;"># test case</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div><br/></div><div>curl -vv --negotiate -u: '<a href="http://cdh-1.evilcorp.pro:9870/webhdfs/v1/?op=LISTSTATUS">http://cdh-1.evilcorp.pro:9870/webhdfs/v1/?op=LISTSTATUS</a>'</div><div><br/></div><div><br/></div><div>curl -i -k -u noobie:noobiepassw0rd -H "X-Requested-By: jonsnow" '<a href="https://cdh-3.evilcorp.pro:8443/gateway/fortknox/webhdfs/v1/?op=LISTSTATUS">https://cdh-3.evilcorp.pro:8443/gateway/fortknox/webhdfs/v1/?op=LISTSTATUS</a>'</div></div><div><br/></div><hr/><div><span style="font-size: 14px; font-family: &quot;Helvetica Neue&quot;; font-weight: bold;"># 3 Give Knox a kerberos keytab </span></div><div><br/></div><div># add service account in ipa</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>ipa user-add knox --first=knox --last=service-account</div></div><div><br/></div><div># create keytab for the user</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">ipa service-add knox/cdh-3.evilcorp.pro@EVILCORP.PRO</span></div><div><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span></div><div><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">ipa-getkeytab -p  </span>knox/cdh-3.evilcorp.pro@EVILCORP.PRO<span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> -k /etc/security/knox.keytab -s ipa.evilcorp.pro </span></div><div><div><br/></div></div></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>chown knox:hadoop /etc/security/knox.keytab</div></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>ls -lrt /etc/security/knox.keytab</div><div>-rw-------. 1 knox hadoop 176 Feb  9 01:51 /etc/security/knox.keytab</div><div><br/></div><div><span style="font-size: 12px; color: rgb(51, 51, 51); font-family: Monaco;">klist -kt </span>/etc/security/knox.keytab</div><div>Keytab name: FILE:/etc/security/knox.keytab</div><div>KVNO Timestamp           Principal</div><div>---- ------------------- ------------------------------------------------------</div><div>   1 02/09/2019 01:51:03 knox/cdh-3.evilcorp.pro@EVILCORP.PRO (aes256-cts-hmac-sha1-96) </div><div>   1 02/09/2019 01:51:03 knox/cdh-3.evilcorp.pro@EVILCORP.PRO (aes128-cts-hmac-sha1-96) </div></div><div><br/></div><div># create topology called ‘fortknox' for proxy services </div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>vim /opt/knox/knox-1.2.0/conf/topologies/fortknox.xml</div></div><div><br/></div><div># configure Knox with ldap</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>                &lt;param&gt;</div><div>                    &lt;name&gt;main.ldapRealm.userDnTemplate&lt;/name&gt;</div><div>                    &lt;value&gt;uid={0},cn=users,cn=accounts,dc=evilcorp,dc=pro&lt;/value&gt;</div><div>                &lt;/param&gt;</div><div>                &lt;param&gt;</div><div>                    &lt;name&gt;main.ldapRealm.contextFactory.url&lt;/name&gt;</div><div>                    &lt;value&gt;<a href="ldaps://ipa.evilcorp.pro:636">ldaps://ipa.evilcorp.pro:636</a>&lt;/value&gt;</div><div>                &lt;/param&gt;</div></div><div><br/></div><div><br/></div><div># make ldaps happy for Knox</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>storepass="changeit"</div><div>JAVA_HOME=/usr/java/jdk1.8.0_141-cloudera</div><div>export PATH=$JAVA_HOME/bin:$PATH</div><div>keytool -importcert -trustcacerts -file /etc/ipa/ca.crt -storepass ${storepass} -noprompt -alias FreeIPACA -keystore ${JAVA_HOME}/jre/lib/security/cacerts</div></div><div><br/></div><div><span style="font-family: &quot;Helvetica Neue&quot;;"># configure Knox service user to proxy other users </span></div><div><img src="Knoxification%20of%20CDH%20clusterz%20-%20master.resources/9473BE9A-3879-447A-B7C4-30D088547612.png" height="355" width="744"/><br/></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>hadoop.proxyuser.knox.groups</div><div>hadoop.proxyuser.knox.hosts</div></div><div><br/></div><div># change ownership of installation directory to Knox</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>chown -R knox:knox /opt/knox/knox-1.2.0</div></div><div><br/></div><div># start Knox</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>sudo -u knox /opt/knox/knox-1.2.0/bin/gateway.sh start</div></div><div><br/></div><hr/><div><span style="font-weight: bold;"># 4 Proxy CDH Services via Knox</span></div><div><br/></div><div># add service definitions in fortknox.xml</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>    &lt;service&gt;</div><div>        &lt;role&gt;WEBHDFS&lt;/role&gt;</div><div>        &lt;url&gt;http://cdh-1.evilcorp.pro:9870/webhdfs&lt;/url&gt;</div><div>    &lt;/service&gt;</div><div><br/></div><div>   &lt;service&gt;</div><div>      &lt;role&gt;YARN&lt;/role&gt;</div><div>      &lt;url&gt;http://cdh-1.evilcorp.pro:8088&lt;/url&gt;</div><div>   &lt;/service&gt;</div><div><br/></div><div>   &lt;service&gt;</div><div>      &lt;role&gt;YARNUI&lt;/role&gt;</div><div>      &lt;url&gt;http://cdh-1.evilcorp.pro:8088&lt;/url&gt;</div><div>   &lt;/service&gt;</div><div><br/></div><div>    &lt;service&gt;</div><div>        &lt;role&gt;SPARKHISTORYUI&lt;/role&gt;</div><div>        &lt;url&gt;http://cdh-1.evilcorp.pro:18088/&lt;/url&gt;</div><div>    &lt;/service&gt;</div></div><div><br/></div><div># Define our domain name “evilcorp.pro” in Knox gateway whitelist</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>vim /opt/knox/knox-1.2.0/conf/gateway-site.xml</div><div><br/></div><div>    &lt;property&gt;</div><div>        &lt;name&gt;gateway.dispatch.whitelist&lt;/name&gt;</div><div>        &lt;value&gt;^https?:\/\/(localhost|127\.0\.0\.1|0:0:0:0:0:0:0:1|::1|.*\.compute-1\.amazonaws\.com|.*\.evilcorp\.pro):[0-9].*$&lt;/value&gt;</div><div>        &lt;description&gt;The whitelist to be applied for dispatches associated with the service roles specified by gateway.dispatch.whitelist.services.</div><div>        If the value is DEFAULT, a domain-based whitelist will be derived from the Knox host.&lt;/description&gt;</div><div>    &lt;/property&gt;</div></div><div><br/></div><div># Force Knox SSO tokens to be able to send over HTTP (This is required because our CDH endpoints are not HTTPS) - NOT recommended for production as JWT cookies are now being sent over insecure channel)</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>vim /opt/knox/knox-1.2.0/conf/topologies/knoxsso.xml</div><div><br/></div><div>        &lt;param&gt;</div><div>            &lt;name&gt;knoxsso.cookie.secure.only&lt;/name&gt;</div><div>            &lt;value&gt;false&lt;/value&gt;</div><div>        &lt;/param&gt;</div></div><div><br/></div><div># create home directory in HDFS</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>[root@cdh-3 noobie]# hadoop fs -mkdir /user/noobie</div><div>[root@cdh-3 noobie]# hadoop fs -chown noobie:noobie /user/noobie</div></div><div><br/></div><div># woot, WEBHDFS works!</div><div><a href="https://cdh-3.evilcorp.pro:8443/gateway/fortknox/webhdfs/v1/?op=LISTSTATUS">https://cdh-3.evilcorp.pro:8443/gateway/fortknox/webhdfs/v1/?op=LISTSTATUS</a></div><div>OR</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>curl -i -k -u noobie:noobiepassw0rd -H "X-Requested-By: jonsnow" '<a href="https://cdh-3.evilcorp.pro:8443/gateway/fortknox/webhdfs/v1/?op=LISTSTATUS">https://cdh-3.evilcorp.pro:8443/gateway/fortknox/webhdfs/v1/?op=LISTSTATUS</a>'</div></div><hr/><div><br/></div><div><span style="font-weight: bold;"># 5 Configure CDH services for SSO</span></div><div>Configure Knox SSO for CDH services</div><div>Apache Knox Reference Doc: <a href="https://knox.apache.org/books/knox-0-12-0/user-guide.html#Participating+Application+Configuration">https://knox.apache.org/books/knox-0-12-0/user-guide.html#Participating+Application+Configuration</a></div><div><br/></div><hr/><div><span style="font-weight: bold;"># 6 Replace Knox’s default SSL certificate with Corporate CA-signed certificate</span></div><div><br/></div><div>(Password for private key: useabetterpassw0rd)</div><div><input checked="true" type="checkbox"/>generate a new key</div><div><a href="https://bgstack15.wordpress.com/2017/05/21/generate-certificate-with-subjectaltname-attributes-in-freeipa/">https://bgstack15.wordpress.com/2017/05/21/generate-certificate-with-subjectaltname-attributes-in-freeipa/</a></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>openssl genrsa -aes256 -out /etc/security/certificates/knox-san.key 2048</div></div><div><br/></div><div><input checked="true" type="checkbox"/>generate csr for hostname knox.evilcorp.pro with SAN cdh-3.evilcorp.pro</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>vim /etc/pki/tls/openssl.cnf</div><div>[req]</div><div>req_extensions          = v3_req</div><div><br/></div><div>[v3_req]</div><div>subjectAltName = @alt_names</div><div>extendedKeyUsage = serverAuth, clientAuth</div><div><br/></div><div>[alt_names]</div><div>DNS.1 = cdh-3.evilcorp.pro</div></div><div><br/></div><div># generate the csr</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>openssl req -new -key /etc/security/certificates/knox-san.key -out /etc/security/certificates/knox-san.csr</div></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div><font color="#919191">Enter pass phrase for /etc/security/certificates/knox-san.key:</font></div><div><font color="#919191">You are about to be asked to enter information that will be incorporated</font></div><div><font color="#919191">into your certificate request.</font></div><div><font color="#919191">What you are about to enter is what is called a Distinguished Name or a DN.</font></div><div><font color="#919191">There are quite a few fields but you can leave some blank</font></div><div><font color="#919191">For some fields there will be a default value,</font></div><div><font color="#919191">If you enter '.', the field will be left blank.</font></div><div><font color="#919191">-----</font></div><div><font color="#919191">Country Name (2 letter code) [XX]:US</font></div><div><font color="#919191">State or Province Name (full name) []:CA</font></div><div><font color="#919191">Locality Name (eg, city) [Default City]:San Jose</font></div><div><font color="#919191">Organization Name (eg, company) [Default Company Ltd]:Cloudera</font></div><div><font color="#919191">Organizational Unit Name (eg, section) []:PM</font></div><div><font color="#919191">Common Name (eg, your name or your server's hostname) []:knox.evilcorp.pro</font></div><div><font color="#919191">Email Address []:youremail@evilcorp.pro</font></div><div><font color="#919191"><br/></font></div><div><font color="#919191">Please enter the following 'extra' attributes</font></div><div><font color="#919191">to be sent with your certificate request</font></div><div><font color="#919191">A challenge password []:</font></div><div><font color="#919191">An optional company name []:</font></div></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>cat /etc/security/certificates/knox-san.csr</div></div><div><br/></div><div><input checked="true" type="checkbox"/>get Knox CSR signed by Corporate CA (IPA CA in our case)</div><div><img src="Knoxification%20of%20CDH%20clusterz%20-%20master.resources/7EB9844A-3CA3-4494-A7E1-F3B85E76435F.png" height="1336" width="2118"/><br/></div><div><br/></div><div><input checked="true" type="checkbox"/>replace Knox's cert on the Knox host</div><div><br/></div><div># First thing first - Take back up and make sure yo use the same secret (useabetterpassw0rd)</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">sudo su</span></div><div><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">cd </span>/opt/knox/knox-1.2.0<span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">/data/security/keystores/</span></div><div><span style="font-family: Monaco;">mkdir backup2</span></div><div><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">mv gateway.jks </span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">__gateway-credentials.jceks backup2/</span></div></div><div><br/></div><div># create a keystore in pkcs12 for Knox out of Knox’s new private key + Signed certificate above + IPA CA cert (password for key is useabetterpassw0rd , export password is changeit)</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">openssl pkcs12 -export -out knox-san</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51); font-weight: bold;">.p12</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> -inkey </span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">/etc/security/certificates/knox-san.key</span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);"> </span><span style="font-family: Monaco;">-in </span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">/etc/security/</span>certificates/<span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">knox-san.crt</span><span style="font-family: Monaco;"> -certfile </span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">/etc/ipa/ca.crt</span></div></div><div><br/></div><div># find the "src alias name..” (To be used in next command) (Password is : changeit)</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">/usr/jdk64/jdk1.8.0_112/bin/keytool -list -v -keystore knox-san.p12</span></div></div><div><br/></div><div># convert PKCS12 keystore into JKS keystore (gateway.jks) for Knox</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">/usr/jdk64/jdk1.8.0_112/bin/keytool</span><span style="font-family: Monaco;"> -importkeystore -srckeystore </span><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51); font-weight: bold;">knox-san.p12</span><span style="font-family: Monaco;"> -srcstoretype pkcs12 -destkeystore gateway.jks -deststoretype jks -srcstorepass changeit -deststorepass </span>useabetterpassw0rd<span style="font-family: Monaco;"> -srcalias </span><span style="font-family: Monaco;background-color: rgb(255, 250, 165);-evernote-highlight:true;">1</span><span style="font-family: Monaco;"> -destalias gateway-identity -destkeypass </span>useabetterpassw0rd</div></div><div><br/></div><div># We don’t need to change gateway-identity-passphrase if we kept password of private key same as the master password. If not, then use the command below to change the Knox master key password.</div><div># store the keystore password in the jks file</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 12px; color: rgb(51, 51, 51);">/usr/hdp/current/knox-server/bin/knoxcli.sh create-alias gateway-identity-passphrase </span><span style="font-family: Monaco;">--value </span>useabetterpassw0rd</div></div><div><br/></div><div># change the certificate for <span style="font-weight: bold;">knox on cdh-3 host</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div> cp /home/noobie/gateway.jks /opt/knox/knox-1.2.0/data/security/keystores/</div></div><div><br/></div><div># restart knox</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>sudo -u knox /opt/knox/knox-1.2.0/bin/gateway.sh stop</div><div>sudo -u knox /opt/knox/knox-1.2.0/bin/gateway.sh start</div></div><div><br/></div><div># export the Knox public certificate (to be used while setting up SSO) (from Knox on cdh-3)</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div># JAVA_HOME=/usr/java/jdk1.8.0_141-cloudera</div><div># $JAVA_HOME/bin/keytool -export -alias gateway-identity -rfc -file /etc/security/sso.pem -keystore /opt/knox/knox-1.2.0/data/security/keystores/gateway.jks</div></div><div><br/></div><div>
<span style="font-size: 13px; background-color: rgb(19, 119, 61); color: rgb(255, 240, 165); font-family: Courier; font-stretch: normal; font-style: normal; font-variant-caps: normal; font-variant-ligatures: no-common-ligatures; font-weight: normal; line-height: normal;">[root@knox keystores]# cat /etc/security/sso.pem</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>-----BEGIN CERTIFICATE-----</div><div>MIIERTCCAy2gAwIBAgIBFTANBgkqhkiG9w0BAQsFADA3MRUwEwYDVQQKDAxFVklM</div><div>Q09SUC5QUk8xHjAcBgNVBAMMFUNlcnRpZmljYXRlIEF1dGhvcml0eTAeFw0xOTAy</div><div>MTMwNTI1NDlaFw0yMTAyMTMwNTI1NDlaMDMxFTATBgNVBAoMDEVWSUxDT1JQLlBS</div><div>TzEaMBgGA1UEAwwRa25veC5ldmlsY29ycC5wcm8wggEiMA0GCSqGSIb3DQEBAQUA</div><div>A4IBDwAwggEKAoIBAQDNGQmGUSDw4gdDxlA42x9u99RvJy397tmYHlpKL2q19iR/</div><div>Df/hMmBtgG483U6WB3oVO+KQrZNRj0l+VzNhgvjZg/+cXd4baRtpsk6z+by0E9u8</div><div>J+JM6geSOjXEHpbpScq/Hjyx5j7quQdoJ0smhMAB+tM08T+9ZH1yzmRpEEzb0h7x</div><div>74FOsnB9wZpPeELu/nK7k1SRkq8ldNeIeSllmuHLhEdhWoXoXbY94rp4AfLQSBdH</div><div>AqU/xLZPDl/UvC/+qriG7kbG4nm9BFXLZCZrTqsi/zwlhsarnRHU/ndUNQxiwZW8</div><div>ZRWqUPtpsR93wSVfkyqHqdwCGKQ2sWUob0rSPCRHAgMBAAGjggFeMIIBWjAfBgNV</div><div>HSMEGDAWgBQnMV3FMpBTRTRQk9TX2C6qkfiYaDA+BggrBgEFBQcBAQQyMDAwLgYI</div><div>KwYBBQUHMAGGImh0dHA6Ly9pcGEtY2EuZXZpbGNvcnAucHJvL2NhL29jc3AwDgYD</div><div>VR0PAQH/BAQDAgTwMB0GA1UdJQQWMBQGCCsGAQUFBwMBBggrBgEFBQcDAjB3BgNV</div><div>HR8EcDBuMGygNKAyhjBodHRwOi8vaXBhLWNhLmV2aWxjb3JwLnByby9pcGEvY3Js</div><div>L01hc3RlckNSTC5iaW6iNKQyMDAxDjAMBgNVBAoMBWlwYWNhMR4wHAYDVQQDDBVD</div><div>ZXJ0aWZpY2F0ZSBBdXRob3JpdHkwHQYDVR0OBBYEFLeplEZzlOQlJg0QPJ1YScw+</div><div>8HUXMDAGA1UdEQQpMCeCEmNkaC0zLmV2aWxjb3JwLnByb4IRa25veC5ldmlsY29y</div><div>cC5wcm8wDQYJKoZIhvcNAQELBQADggEBAKokBRYDkAQLnMGrtdOj31K4hg0m6Sns</div><div>DYhdOClteznM7awZCyM6JJ7vl8e8e9RDmh8kGo1mOg64QcdANwntjYDbY0nQnVci</div><div>iDVrCLHjzurxLhh2CeHdKgpQGKapm7+5jrjhECdJ/W4UV8c9WBWCUkniWcIl8Ynk</div><div>Rz390lWBzNfOSR4+Vyn41VNm2L+IUF4o+TVcK7Lr7MEJiTjx9rv5zL3NWomljDk6</div><div>6pew3FThm2XQZj3rK5dIQ4ZuVOlbSO33PVaviN5snv+DHYTvsRGayk+35IQGvSPl</div><div>0/Esq+/hNNwHqb7l9ldEDNZh3BTrd6HueqRED0DyIS4ETDIvUbuQzX8=</div><div>-----END CERTIFICATE-----</div></div><div><br/></div><hr/><div><span style="font-weight: bold;">Configuring Knox SSO for Hadoop Core Services in Cloudera Manager</span></div><div><br/></div><div># Check box the Hadoop HTTP Authentication textbox in Cloudera Manager for BOTH HDFS and YARN !!! </div><div><br/></div><div># add custom properties in hdfs core-site safety valve </div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>&lt;property&gt;</div><div>    &lt;name&gt;hadoop.http.authentication.type&lt;/name</div><div> &lt;value&gt;org.apache.hadoop.security.authentication.server.JWTRedirectAuthenticationHandler&lt;/value&gt;</div><div>&lt;/property&gt;</div></div><div><br/></div><div># add the Knox SSO public certificate</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>&lt;property&gt;</div><div>    &lt;name&gt;hadoop.http.authentication.public.key.pem&lt;/name&gt;</div><div>    &lt;value&gt;</div><div>MIIERTCCAy2gAwIBAgIBFTANBgkqhkiG9w0BAQsFADA3MRUwEwYDVQQKDAxFVklM</div><div>Q09SUC5QUk8xHjAcBgNVBAMMFUNlcnRpZmljYXRlIEF1dGhvcml0eTAeFw0xOTAy</div><div>MTMwNTI1NDlaFw0yMTAyMTMwNTI1NDlaMDMxFTATBgNVBAoMDEVWSUxDT1JQLlBS</div><div>TzEaMBgGA1UEAwwRa25veC5ldmlsY29ycC5wcm8wggEiMA0GCSqGSIb3DQEBAQUA</div><div>A4IBDwAwggEKAoIBAQDNGQmGUSDw4gdDxlA42x9u99RvJy397tmYHlpKL2q19iR/</div><div>Df/hMmBtgG483U6WB3oVO+KQrZNRj0l+VzNhgvjZg/+cXd4baRtpsk6z+by0E9u8</div><div>J+JM6geSOjXEHpbpScq/Hjyx5j7quQdoJ0smhMAB+tM08T+9ZH1yzmRpEEzb0h7x</div><div>74FOsnB9wZpPeELu/nK7k1SRkq8ldNeIeSllmuHLhEdhWoXoXbY94rp4AfLQSBdH</div><div>AqU/xLZPDl/UvC/+qriG7kbG4nm9BFXLZCZrTqsi/zwlhsarnRHU/ndUNQxiwZW8</div><div>ZRWqUPtpsR93wSVfkyqHqdwCGKQ2sWUob0rSPCRHAgMBAAGjggFeMIIBWjAfBgNV</div><div>HSMEGDAWgBQnMV3FMpBTRTRQk9TX2C6qkfiYaDA+BggrBgEFBQcBAQQyMDAwLgYI</div><div>KwYBBQUHMAGGImh0dHA6Ly9pcGEtY2EuZXZpbGNvcnAucHJvL2NhL29jc3AwDgYD</div><div>VR0PAQH/BAQDAgTwMB0GA1UdJQQWMBQGCCsGAQUFBwMBBggrBgEFBQcDAjB3BgNV</div><div>HR8EcDBuMGygNKAyhjBodHRwOi8vaXBhLWNhLmV2aWxjb3JwLnByby9pcGEvY3Js</div><div>L01hc3RlckNSTC5iaW6iNKQyMDAxDjAMBgNVBAoMBWlwYWNhMR4wHAYDVQQDDBVD</div><div>ZXJ0aWZpY2F0ZSBBdXRob3JpdHkwHQYDVR0OBBYEFLeplEZzlOQlJg0QPJ1YScw+</div><div>8HUXMDAGA1UdEQQpMCeCEmNkaC0zLmV2aWxjb3JwLnByb4IRa25veC5ldmlsY29y</div><div>cC5wcm8wDQYJKoZIhvcNAQELBQADggEBAKokBRYDkAQLnMGrtdOj31K4hg0m6Sns</div><div>DYhdOClteznM7awZCyM6JJ7vl8e8e9RDmh8kGo1mOg64QcdANwntjYDbY0nQnVci</div><div>iDVrCLHjzurxLhh2CeHdKgpQGKapm7+5jrjhECdJ/W4UV8c9WBWCUkniWcIl8Ynk</div><div>Rz390lWBzNfOSR4+Vyn41VNm2L+IUF4o+TVcK7Lr7MEJiTjx9rv5zL3NWomljDk6</div><div>6pew3FThm2XQZj3rK5dIQ4ZuVOlbSO33PVaviN5snv+DHYTvsRGayk+35IQGvSPl</div><div>0/Esq+/hNNwHqb7l9ldEDNZh3BTrd6HueqRED0DyIS4ETDIvUbuQzX8=</div><div>&lt;/value&gt;</div><div>&lt;/property&gt;</div></div><hr/><div># Add Knox SSO provider URL</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>&lt;property&gt;</div><div>    &lt;name&gt;hadoop.http.authentication.authentication.provider.url&lt;/name&gt;</div><div>    &lt;value&gt;https://cdh-3.evilcorp.pro:8443/gateway/knoxsso/api/v1/websso&lt;/value&gt;</div><div>&lt;/property&gt;</div></div><div><br/></div><div>#  Add white listing for user-agents where SSO is NOT applicable (they fallback to Kerberos authentication)</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>&lt;property&gt;</div><div>    &lt;name&gt;hadoop.http.authentication.alt-kerberos.non-browser.user-agents&lt;/name&gt;</div><div>    &lt;value&gt;java,curl,wget,perl,python&lt;/value&gt;</div><div>&lt;/property&gt;</div></div><div><br/></div><div># Screenshot of all core-site property changes in Cloudera Manager</div><div><img src="Knoxification%20of%20CDH%20clusterz%20-%20master.resources/7588242F-6FFF-490A-839C-CC142B33EB0B.png" height="1452" width="2888"/><br/></div><div><br/></div><div># Config changes for Spark History Server in safety valve (CDH cluster)</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div># Spark Service Environment Advanced Configuration Snippet (Safety Valve)</div><div>ENABLE_SPNEGO=false</div><div>YARN_PROXY_REDIRECT=false</div><div><br/></div><div># History Server Advanced Configuration Snippet (Safety Valve) for spark-conf/spark-history-server.conf</div><div>spark.history.ui.acls.enable=true</div><div>spark.ui.filters=org.apache.spark.deploy.yarn.YarnProxyRedirectFilter,org.apache.hadoop.security.authentication.server.AuthenticationFilter</div><div>spark.org.apache.hadoop.security.authentication.server.AuthenticationFilter.param.type=org.apache.hadoop.security.authentication.server.JWTRedirectAuthenticationHandler</div><div>spark.org.apache.hadoop.security.authentication.server.AuthenticationFilter.param.kerberos.principal=HTTP/cdh-1.evilcorp.pro@EVILCORP.PRO</div><div>spark.org.apache.hadoop.security.authentication.server.AuthenticationFilter.param.kerberos.keytab=spark_on_yarn.keytab</div><div>spark.org.apache.hadoop.security.authentication.server.AuthenticationFilter.param.kerberos.name.rules=DEFAULT\u000A</div><div>spark.org.apache.hadoop.security.authentication.server.AuthenticationFilter.param.authentication.provider.url=https://cdh-3.evilcorp.pro:8443/gateway/knoxsso/api/v1/websso</div><div>spark.org.apache.hadoop.security.authentication.server.AuthenticationFilter.param.public.key.pem=MIIERTCCAy2gAwIBAgIBFTANBgkqhkiG9w0BAQsFADA3MRUwEwYDVQQKDAxFVklMQ09SUC5QUk8xHjAcBgNVBAMMFUNlcnRpZmljYXRlIEF1dGhvcml0eTAeFw0xOTAyMTMwNTI1NDlaFw0yMTAyMTMwNTI1NDlaMDMxFTATBgNVBAoMDEVWSUxDT1JQLlBSTzEaMBgGA1UEAwwRa25veC5ldmlsY29ycC5wcm8wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQDNGQmGUSDw4gdDxlA42x9u99RvJy397tmYHlpKL2q19iR/Df/hMmBtgG483U6WB3oVO+KQrZNRj0l+VzNhgvjZg/+cXd4baRtpsk6z+by0E9u8J+JM6geSOjXEHpbpScq/Hjyx5j7quQdoJ0smhMAB+tM08T+9ZH1yzmRpEEzb0h7x74FOsnB9wZpPeELu/nK7k1SRkq8ldNeIeSllmuHLhEdhWoXoXbY94rp4AfLQSBdHAqU/xLZPDl/UvC/+qriG7kbG4nm9BFXLZCZrTqsi/zwlhsarnRHU/ndUNQxiwZW8ZRWqUPtpsR93wSVfkyqHqdwCGKQ2sWUob0rSPCRHAgMBAAGjggFeMIIBWjAfBgNVHSMEGDAWgBQnMV3FMpBTRTRQk9TX2C6qkfiYaDA+BggrBgEFBQcBAQQyMDAwLgYIKwYBBQUHMAGGImh0dHA6Ly9pcGEtY2EuZXZpbGNvcnAucHJvL2NhL29jc3AwDgYDVR0PAQH/BAQDAgTwMB0GA1UdJQQWMBQGCCsGAQUFBwMBBggrBgEFBQcDAjB3BgNVHR8EcDBuMGygNKAyhjBodHRwOi8vaXBhLWNhLmV2aWxjb3JwLnByby9pcGEvY3JsL01hc3RlckNSTC5iaW6iNKQyMDAxDjAMBgNVBAoMBWlwYWNhMR4wHAYDVQQDDBVDZXJ0aWZpY2F0ZSBBdXRob3JpdHkwHQYDVR0OBBYEFLeplEZzlOQlJg0QPJ1YScw+8HUXMDAGA1UdEQQpMCeCEmNkaC0zLmV2aWxjb3JwLnByb4IRa25veC5ldmlsY29ycC5wcm8wDQYJKoZIhvcNAQELBQADggEBAKokBRYDkAQLnMGrtdOj31K4hg0m6SnsDYhdOClteznM7awZCyM6JJ7vl8e8e9RDmh8kGo1mOg64QcdANwntjYDbY0nQnVciiDVrCLHjzurxLhh2CeHdKgpQGKapm7+5jrjhECdJ/W4UV8c9WBWCUkniWcIl8YnkRz390lWBzNfOSR4+Vyn41VNm2L+IUF4o+TVcK7Lr7MEJiTjx9rv5zL3NWomljDk66pew3FThm2XQZj3rK5dIQ4ZuVOlbSO33PVaviN5snv+DHYTvsRGayk+35IQGvSPl0/Esq+/hNNwHqb7l9ldEDNZh3BTrd6HueqRED0DyIS4ETDIvUbuQzX8=</div></div><div><br/></div><hr/><div><span style="font-weight: bold;"># Cloudera Manager Tips for using Knox:</span></div><ul><li><div>Namenode UI link - Need to use <a href="http://cdh-1.evilcorp.pro:9870/index.html">http://cdh-1.evilcorp.pro:9870/index.html</a> and NOT <a href="http://ec2-52-206-223-66.compute-1.amazonaws.com:9870/">http://ec2-52-206-223-66.compute-1.amazonaws.com:9870/</a> to ensure that the cookie domains match. CM currently has AWS domain name for quick link</div></li><li><div>Make sure to configure http auth for HDFS &amp; YARN!! </div></li></ul><div><br/></div><hr/></body></html>